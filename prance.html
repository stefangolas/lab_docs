
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PRANCE &mdash; Modular Lab 0.0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css-style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Turbidostat" href="turbidostat.html" />
    <link rel="prev" title="Experimental Data Repository" href="general/experimental_data_repository.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Modular Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="general/pyhamilton.html">PyHamilton</a></li>
<li class="toctree-l1"><a class="reference internal" href="general/experimental_data_repository.html">Experimental Data Repository</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">PRANCE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">Run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lagoon-prep">Lagoon Prep</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bleach-tips">Bleach Tips</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prep-reader-plate">Prep Reader Plate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-plate">Read Plate</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="turbidostat.html">Turbidostat</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Modular Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">PRANCE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/prance.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="prance">
<h1>PRANCE<a class="headerlink" href="#prance" title="Permalink to this heading"></a></h1>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this heading"></a></h2>
</section>
<section id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this heading"></a></h2>
<section id="lagoon-prep">
<h3>Lagoon Prep<a class="headerlink" href="#lagoon-prep" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/lagoon_prep.png"><img alt="_images/lagoon_prep.png" src="_images/lagoon_prep.png" style="width: 800px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prep_lagoons</span><span class="p">(</span><span class="n">state_data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prep_lagoons&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Start of cycle&#39;</span><span class="p">)</span>
    <span class="n">state_data</span><span class="o">.</span><span class="n">error_recovery</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">lagoon_tips</span> <span class="o">=</span> <span class="n">lagoon_tips_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span><span class="p">)</span>
    <span class="c1"># wait for waffle to finish cleaning</span>
    <span class="n">state_data</span><span class="o">.</span><span class="n">iter_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">wash_empty_refill</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">refillAfterEmpty</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>    <span class="c1"># 3=Refill chamber 2 only, which is BLEACH, 1 = refill both chambers</span>
                    <span class="n">chamber1WashLiquid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#1=Liquid 2 (water)</span>
                    <span class="n">chamber2WashLiquid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 0=Liquid 1 (red container) (bleach)</span>
    <span class="n">async_clean</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">tip_pick_up_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoon_tips</span><span class="p">)</span>
    <span class="c1"># Move holding well contents to inducing site</span>
    <span class="n">aspirate_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">holding_wells</span><span class="p">,</span> <span class="mi">450</span><span class="p">)</span><span class="c1">#TODO: holding wells empty vol needs to be about 50uL or else will grow too much ## Raise the liquid height a little if they&#39;re not growing enough in the wells</span>
    <span class="n">dispense_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer_wells</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="n">mixCycles</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="n">mixVolume</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dispenseMode</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span> <span class="c1">#TODO: do we need airTransportRetractDist=30, dispenseMode=9 (mode: blowout)?</span>
    <span class="n">aspirate_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer_wells</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span> <span class="c1"># 1.5 cm is about the right height for 350 uL</span>
    <span class="n">dispense_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoons</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="n">mixCycles</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mixVolume</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dispenseMode</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span> <span class="c1">#TODO: do we need airTransportRetractDist=30, dispenseMode=9 (mode: blowout)?</span>
    <span class="c1"># Drain lagoons to constant height</span>
    <span class="n">aspirate_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoons</span><span class="p">,</span> <span class="n">air_vol</span><span class="p">,</span> <span class="n">liquidHeight</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span><span class="c1">#TODO: holding wells empty vol needs to be about 50uL or else will grow too much ## Raise the liquid height a little if they&#39;re not growing enough in the wells</span>
    <span class="n">aspirate_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoons</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="n">fixed_lagoon_height</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span>
    <span class="n">dispense_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">waste</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dispenseMode</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span>
    <span class="n">dispense_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">waste</span><span class="p">,</span> <span class="n">air_vol</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dispenseMode</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">liq_move_param</span><span class="p">)</span>


    <span class="n">state_data</span><span class="o">.</span><span class="n">write_state_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">state_data</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="bleach-tips">
<h3>Bleach Tips<a class="headerlink" href="#bleach-tips" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/bleach_tips.png"><img alt="_images/bleach_tips.png" src="_images/bleach_tips.png" style="width: 800px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bleach_mounted_tips_step</span><span class="p">(</span><span class="n">state_data</span><span class="p">):</span>

<span class="n">lagoon_tips</span> <span class="o">=</span> <span class="n">lagoon_tips_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span><span class="p">)</span>
<span class="k">if</span> <span class="n">state_data</span><span class="o">.</span><span class="n">error_recovery</span><span class="p">:</span>
    <span class="n">tip_pick_up_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoon_tips</span><span class="p">)</span>

<span class="n">state_data</span><span class="o">.</span><span class="n">error_recovery</span><span class="o">=</span><span class="kc">False</span>


<span class="n">bacteria_to_use</span> <span class="o">=</span> <span class="n">read_manifest</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>

<span class="n">bacteria_id_tuple</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

<span class="n">first_bacteria</span><span class="o">=</span><span class="n">get_first_bacteria</span><span class="p">(</span><span class="n">bacteria_id_tuple</span><span class="p">,</span> <span class="n">bacteria_to_use</span><span class="p">)</span>
<span class="n">pump_first_culture</span><span class="o">=</span><span class="n">run_async_dict</span><span class="p">({</span>
    <span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="n">pump_culture</span><span class="p">,</span>
    <span class="s1">&#39;arguments&#39;</span><span class="p">:{</span>
        <span class="s1">&#39;bacteria_id&#39;</span><span class="p">:</span><span class="n">first_bacteria</span><span class="p">,</span>
        <span class="s1">&#39;bacteria_controller&#39;</span><span class="p">:</span><span class="n">bacteria_to_use</span>
        <span class="p">}</span>
    <span class="p">})</span>



<span class="n">bleach_mounted_tips</span><span class="p">()</span>
<span class="n">tip_eject_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoon_tips</span><span class="p">)</span>
<span class="n">pump_first_culture</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="prep-reader-plate">
<h3>Prep Reader Plate<a class="headerlink" href="#prep-reader-plate" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/prep_reader_plate.png"><img alt="_images/prep_reader_plate.png" src="_images/prep_reader_plate.png" style="width: 800px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reader_plate_prep</span><span class="p">(</span><span class="n">state_data</span><span class="p">):</span>
    <span class="n">state_data</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Prepping reader plate&quot;</span><span class="p">)</span>
    <span class="n">state_data</span><span class="o">.</span><span class="n">error_recovery</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">rplate_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">//</span><span class="n">cycles_per_read</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_lagoons</span><span class="p">)</span> <span class="o">%</span> <span class="mi">96</span> <span class="c1"># e.g. if there are 24 lagoons, this is 0, 24, 48, 72, 0, 24... on successive full cycles</span>
    <span class="n">next_rplate_switch</span> <span class="o">=</span> <span class="p">((</span><span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">num_lagoons</span><span class="o">/</span><span class="n">cycles_per_read</span><span class="p">))))</span> <span class="o">%</span> <span class="mi">96</span><span class="o">==</span><span class="mi">0</span>
    <span class="c1">#rplate_start = (iteration_counter * num_lagoons) % 96</span>
    <span class="k">if</span> <span class="n">next_rplate_switch</span> <span class="ow">and</span> <span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># if we&#39;re starting (over) at index 0 of a reader plate</span>
        <span class="n">state_data</span><span class="o">.</span><span class="n">reader_plates_iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">reader_plate</span> <span class="o">=</span> <span class="n">reader_plate_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">reader_plates_iter</span><span class="p">)</span>

    <span class="n">rp_lid</span> <span class="o">=</span> <span class="n">reader_plate</span><span class="o">.</span><span class="n">_layout_name</span> <span class="o">+</span> <span class="s1">&#39;_lid&#39;</span>
    <span class="c1"># Read controller manifest</span>
    <span class="n">bacteria_to_use</span> <span class="o">=</span> <span class="n">read_manifest</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>

    <span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">lagoon_tips</span> <span class="o">=</span> <span class="n">lagoon_tips_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">%</span><span class="n">cycles_per_read</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">reading</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reading</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">reading</span> <span class="ow">and</span> <span class="n">using_lids</span><span class="p">:</span>
            <span class="n">lid_rp_to_park</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">rp_lid</span><span class="p">,</span> <span class="n">park_seq</span><span class="p">)</span>

    <span class="n">bacteria_id_tuple</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">first_bacteria</span><span class="o">=</span><span class="n">get_first_bacteria</span><span class="p">(</span><span class="n">bacteria_id_tuple</span><span class="p">,</span> <span class="n">bacteria_to_use</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bacteria</span> <span class="ow">in</span> <span class="n">bacteria_id_tuple</span><span class="p">:</span>
        <span class="n">culture_total_vol</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">bacteria_to_use</span><span class="p">[</span><span class="n">well</span><span class="p">][</span><span class="s1">&#39;vol&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">1000</span> <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">bacteria_to_use</span> <span class="k">if</span> <span class="n">bacteria_to_use</span><span class="p">[</span><span class="n">well</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">bacteria</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bacteria</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bacteria_to_use</span><span class="p">[</span><span class="n">well</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">bacteria_to_use</span><span class="p">]:</span>
            <span class="k">continue</span> <span class="c1"># skip filling bacteria we won&#39;t use, or if it was already pumped in the last step</span>

        <span class="k">if</span> <span class="n">bacteria</span><span class="o">!=</span><span class="n">first_bacteria</span><span class="p">:</span>
            <span class="n">state_data</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Rinsing waffle&quot;</span><span class="p">)</span>
            <span class="n">pump_int</span><span class="o">.</span><span class="n">rinse_out</span><span class="p">(</span><span class="n">rinse_cycles</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">state_data</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Pumping bacteria culture &quot;</span> <span class="o">+</span> <span class="n">bacteria</span><span class="p">)</span>
            <span class="n">pump_int</span><span class="o">.</span><span class="n">refill_culture</span><span class="p">(</span><span class="n">bacteria</span><span class="p">,</span><span class="n">culture_total_vol</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_lagoons</span><span class="o">//</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># explicitly skip every other column in this method by supplying 2 as range()&#39;s 3rd arg</span>
            <span class="n">number_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">column</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># e.g. 0-7, 16-23, ...</span>
            <span class="n">rplate_column</span> <span class="o">=</span> <span class="n">column</span><span class="o">//</span><span class="mi">2</span> <span class="c1"># int-divide by 2 to pack every column of reader plates</span>
            <span class="n">rplate_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">rplate_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">rplate_column</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">rplate_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">rplate_column</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># e.g. 0-7, 8-15...</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rplate_range</span><span class="p">)</span>

            <span class="c1"># initialize so many parallel lists</span>
            <span class="n">column_tips</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_vols</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_waffle</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_wells</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">column_lagoons</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_rplate_vols</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_rplate</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_bleach</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">column_waste</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="c1"># build the lists. each will have length 8 when we&#39;re done, one entry per 1000uL channel.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="c1"># iterate over our lagoon positions and reader plate positions in parallel</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">number_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">rplate_num</span> <span class="o">=</span> <span class="n">rplate_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">well_id</span> <span class="o">=</span> <span class="n">lagoons</span><span class="o">.</span><span class="n">position_id</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="c1"># &#39;A1&#39;, &#39;H3&#39;, etc.</span>

                <span class="k">if</span> <span class="n">well_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bacteria_to_use</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bacteria_to_use</span><span class="p">[</span><span class="n">well_id</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">bacteria</span><span class="p">:</span>
                    <span class="n">column_tips</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lagoon_tips</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                    <span class="n">column_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bacteria_to_use</span><span class="p">[</span><span class="n">well_id</span><span class="p">][</span><span class="s1">&#39;vol&#39;</span><span class="p">]))</span> <span class="c1">#TODO: actual replacement volume?</span>
                    <span class="n">column_waffle</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">waffle</span><span class="p">,</span> <span class="n">num</span><span class="o">%</span><span class="mi">8</span><span class="p">))</span> <span class="c1"># mod 8 plus 88 makes all the indices fall in the rightmost column of the waffle, the range 88-95, where the 8-channel can reach</span>
                    <span class="n">column_wells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">holding_wells</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span> <span class="c1"># we&#39;ll be moving culture to holding wells, /not/ lagoons</span>
                    <span class="n">column_lagoons</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lagoons</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span> <span class="c1"># we&#39;ll sample some liquid from the lagoons into the reader plate though</span>
                    <span class="n">column_rplate_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reader_vol</span><span class="p">)</span> <span class="c1"># the normal sample volume to measure with the plate reader</span>
                    <span class="n">column_rplate</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">reader_plate</span><span class="p">,</span> <span class="n">rplate_num</span><span class="p">))</span>
                    <span class="n">column_bleach</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bleach</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                    <span class="n">column_waste</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">waste</span><span class="p">,</span> <span class="n">num</span><span class="o">%</span><span class="mi">8</span><span class="o">+</span><span class="mi">88</span><span class="p">))</span>  <span class="c1"># mod 8 plus 88 makes all the indices fall in the rightmost column of the waffle, the range 88-95, where the 8-channel can reach</span>
                <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># add gaps between the 8-channel&#39;s tips wherever the bacteria doesn&#39;t match</span>
                    <span class="n">column_tips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_waffle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_wells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_lagoons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_rplate_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_rplate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_bleach</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">column_waste</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">column_tips</span><span class="p">):</span>
                <span class="k">continue</span> <span class="c1"># skip an empty column</span>

            <span class="c1"># finished building command lists.</span>
            <span class="c1"># Pick up some of the same tips we just washed</span>
            <span class="n">state_data</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Adding bacteria &quot;</span> <span class="o">+</span> <span class="n">bacteria</span> <span class="o">+</span> <span class="s2">&quot; to wells&quot;</span><span class="p">)</span>
            <span class="n">tip_pick_up</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_tips</span><span class="p">)</span>

            <span class="c1"># Move appropriate bacteria to holding wells</span>
            <span class="n">aspirate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_waffle</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">)</span>
            <span class="n">dispense</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_wells</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="n">lagoon_fly_disp_height</span><span class="p">)</span>
            <span class="c1"># Move a lagoon sample into the reader plate (ok to use these &quot;dirty&quot; tips because the bacteria should be the same as in the lagoon, by and large)</span>
            <span class="k">if</span> <span class="n">reading</span><span class="p">:</span>
                <span class="c1"># Move a lagoon sample into the reader plate (ok to use these &quot;dirty&quot; tips because the bacteria should be the same as in the lagoon, by and large)</span>
                <span class="n">aspirate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_lagoons</span><span class="p">,</span> <span class="n">column_rplate_vols</span><span class="p">,</span> <span class="n">liquidHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">dispense</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_rplate</span><span class="p">,</span> <span class="n">column_rplate_vols</span><span class="p">,</span> <span class="n">liquidHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
            <span class="c1">#Quick dispense waste</span>
            <span class="n">aspirate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_waste</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">dispense</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_waste</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1">#adjusting_flow:</span>

                <span class="c1">#adj_flowrate = flowrate - reader_vol*reading</span>
                <span class="n">aspirate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_lagoons</span><span class="p">,</span> <span class="n">column_rplate_vols</span><span class="p">,</span> <span class="n">liquidHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">dispense</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_rplate</span><span class="p">,</span> <span class="n">column_rplate_vols</span><span class="p">,</span> <span class="n">liquidHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Quick bleach tips</span>
            <span class="n">column_vols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">300</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_vols</span><span class="p">]</span> <span class="c1"># add some excess liquid to aspirating</span>
            <span class="n">aspirate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_bleach</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dispense</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_bleach</span><span class="p">,</span> <span class="n">column_vols</span><span class="p">)</span>
            <span class="c1"># Put tips back</span>
            <span class="n">tip_eject</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">column_tips</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reading</span> <span class="ow">and</span> <span class="n">using_lids</span><span class="p">:</span>
        <span class="n">lid_park_to_rp</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">park_seq</span><span class="p">,</span> <span class="n">rp_lid</span><span class="p">)</span>

    <span class="c1"># Start cleaning waffle while we do other things</span>
    <span class="n">async_clean</span> <span class="o">=</span> <span class="n">run_async</span><span class="p">(</span><span class="n">clean_waffle</span><span class="p">)</span>


    <span class="n">state_data</span><span class="o">.</span><span class="n">write_state_data</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">state_data</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="read-plate">
<h3>Read Plate<a class="headerlink" href="#read-plate" title="Permalink to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/read_plate.png"><img alt="_images/read_plate.png" src="_images/read_plate.png" style="width: 800px;" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">state_data</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="s2">&quot;Reading plate&quot;</span><span class="p">)</span>
<span class="n">rplate_start</span> <span class="o">=</span> <span class="p">((</span><span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">//</span><span class="n">cycles_per_read</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_lagoons</span><span class="p">)</span> <span class="o">%</span> <span class="mi">96</span>
<span class="n">state_data</span><span class="o">.</span><span class="n">error_recovery</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">lagoon_tips</span> <span class="o">=</span> <span class="n">lagoon_tips_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">lagoon_tips_iter</span><span class="p">)</span>
<span class="n">reader_plate</span> <span class="o">=</span> <span class="n">reader_plate_cycle</span><span class="p">(</span><span class="n">state_data</span><span class="o">.</span><span class="n">reader_plates_iter</span><span class="p">)</span>

<span class="n">bacteria_to_use</span> <span class="o">=</span> <span class="n">read_manifest</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">induce_and_wash_in_parallel</span><span class="p">():</span>
            <span class="c1"># Add inducer and wash tips</span>
            <span class="n">tip_pick_up_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer_tips</span><span class="p">)</span>
            <span class="n">aspirate_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer</span><span class="p">,</span> <span class="n">inducer_vol</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">liquidClass</span> <span class="o">=</span> <span class="s1">&#39;StandardVolumeFilter_Water_DispenseSurface_Empty&#39;</span><span class="p">)</span> <span class="c1"># 30 uL inducer into 350 uL lagoon, final 10uM Arabinose (10x)</span>
            <span class="n">dispense_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer_wells</span><span class="p">,</span> <span class="n">inducer_vol</span><span class="p">,</span> <span class="n">liquidHeight</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">liquidClass</span> <span class="o">=</span> <span class="s1">&#39;StandardVolumeFilter_Water_DispenseSurface_Empty&#39;</span><span class="p">)</span>
            <span class="n">bleach_mounted_tips_300</span><span class="p">()</span>
            <span class="n">tip_eject_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">inducer_tips</span><span class="p">)</span>
            <span class="c1"># Wash lagoon tips</span>
            <span class="n">tip_pick_up_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoon_tips</span><span class="p">)</span>
            <span class="n">bleach_mounted_tips</span><span class="p">()</span>
            <span class="n">tip_eject_96</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">lagoon_tips</span><span class="p">)</span>

<span class="n">barcode</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">platedatas</span> <span class="o">=</span> <span class="n">read_plate</span><span class="p">(</span><span class="n">ham_int</span><span class="p">,</span> <span class="n">reader_int</span><span class="p">,</span> <span class="n">reader_tray</span><span class="p">,</span> <span class="n">reader_plate</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">plate_id</span><span class="o">=</span><span class="n">reader_plate</span><span class="o">.</span><span class="n">layout_name</span><span class="p">(),</span> <span class="n">async_task</span><span class="o">=</span><span class="n">induce_and_wash_in_parallel</span><span class="p">,</span> <span class="n">using_lid</span> <span class="o">=</span> <span class="n">using_lids</span><span class="p">)</span>
<span class="c1"># extract readings and enter in database</span>
<span class="n">abs_platedata</span><span class="p">,</span> <span class="n">lum_platedata</span> <span class="o">=</span> <span class="n">platedatas</span>
<span class="n">lagoon_numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lagoons</span><span class="p">)</span> <span class="c1"># the list of (integer) labels for lagoons</span>
<span class="n">rplate_well_numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">rplate_start</span><span class="p">,</span> <span class="n">rplate_start</span> <span class="o">+</span> <span class="n">num_lagoons</span><span class="p">)</span> <span class="c1"># the corresponding list indices in the reader plate</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;wells range is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rplate_well_numbers</span><span class="p">))</span>

<span class="k">if</span> <span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span><span class="o">%</span><span class="n">cycles_per_read</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">db_add_plate_data</span><span class="p">(</span><span class="n">lum_platedata</span><span class="p">,</span> <span class="s1">&#39;lum&#39;</span><span class="p">,</span> <span class="n">reader_plate</span><span class="p">,</span> <span class="n">lagoon_numbers</span><span class="p">,</span> <span class="n">rplate_well_numbers</span><span class="p">,</span> <span class="n">bacteria_to_use</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">exp_dir_path</span><span class="p">)</span>
    <span class="n">db_add_plate_data</span><span class="p">(</span><span class="n">abs_platedata</span><span class="p">,</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">reader_plate</span><span class="p">,</span> <span class="n">lagoon_numbers</span><span class="p">,</span> <span class="n">rplate_well_numbers</span><span class="p">,</span> <span class="n">bacteria_to_use</span><span class="p">,</span> <span class="n">barcode</span><span class="p">,</span> <span class="n">exp_dir_path</span><span class="p">)</span>

<span class="n">state_data</span><span class="o">.</span><span class="n">iteration_counter</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="n">state_data</span><span class="o">.</span><span class="n">write_state_data</span><span class="p">()</span>

<span class="n">automatic_drain_thread</span> <span class="o">=</span> <span class="n">RaisingThread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">automatic_waste_drain</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">automatic_drain_arguments</span><span class="p">)</span>
<span class="n">automatic_drain_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;entering wait block&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">simulating</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cycle_time</span><span class="o">*</span><span class="mi">60</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">state_data</span><span class="o">.</span><span class="n">iter_start_time</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will try sleeping&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cycle_time</span><span class="o">*</span><span class="mi">60</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">state_data</span><span class="o">.</span><span class="n">iter_start_time</span><span class="p">))</span> <span class="c1"># wait whatever remains of the cycle</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;done sleeping&#39;</span><span class="p">)</span>
   <span class="c1"># except KeyboardInterrupt:</span>
   <span class="c1">#     logging.info(&#39;keyboard interrupt while sleeping&#39;)</span>
   <span class="c1">#     pass # allow cancellation of delay with CTRL+C</span>

<span class="n">automatic_drain_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="k">return</span> <span class="p">(</span><span class="n">state_data</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this heading"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="general/experimental_data_repository.html" class="btn btn-neutral float-left" title="Experimental Data Repository" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="turbidostat.html" class="btn btn-neutral float-right" title="Turbidostat" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Stefan Golas.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
  <h2>My footer of awesomeness.</h2>
   


</body>
</html>